<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulario de Reporte de Incidentes – CMA</title>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h2 {
      background: #0073e6;
      color: white;
      padding: 8px;
      border-radius: 5px;
    }
    label {
      display: block;
      margin: 8px 0 4px;
      font-weight: bold;
    }
    input[type="text"], input[type="datetime-local"], textarea {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    textarea {
      resize: vertical;
    }
    .checkbox-group label {
      font-weight: normal;
      display: block;
      margin-bottom: 4px;
    }
    .steps {
      margin-bottom: 12px;
    }
    .step-item {
      margin-bottom: 6px;
      display: flex;
      gap: 0.5rem;
    }
    button {
      background-color: #0073e6;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 12px;
    }
    button:hover {
      background-color: #005bb5;
    }
    .image-preview img {
      max-width: 250px;
      max-height: 250px;
      margin: 5px 5px 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .group-horizontal {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .group-item {
      flex: 1;
      min-width: 250px;
    }

    .checkbox-group.column {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .checkbox-group.column label {
      display: flex;
      align-items: center;
    }

  </style>
</head>
<body>

  <h1>Formulario de Reporte de Incidentes – CMA</h1>

  <form id="reportForm">
    <label for="issueTitle">Título referencial:</label>
    <input type="text" id="issueTitle" name="issueTitle" required>

    <h2>Información general</h2>

    <div class="group-horizontal">
      <div class="group-item">
        <label for="userContact">Nombre y contacto del usuario:</label>
        <div class="checkbox-group">
          <input type="text" id="userContact" name="userContact" required>
        </div>
      </div>
    
      <div class="group-item">
        <label for="datetimeTest">Fecha y hora de prueba:</label>
        <div class="checkbox-group">
          <input type="datetime-local" id="datetimeTest" name="datetimeTest" required>
        </div>
      </div>
    </div>

    <div class="group-horizontal">
      <div class="group-item">
        <label>Plataformas afectadas:</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="platforms" value="Billetera Personal" /> Billetera Personal</label>
          <label><input type="checkbox" name="platforms" value="Billetera Comercial" /> Billetera Comercial</label>
          <label><input type="checkbox" name="platforms" value="Link de Pago" /> Link de Pago</label>
          <label><input type="checkbox" name="platforms" value="Comedor Saas" /> Comedor Saas</label>
          <label><input type="checkbox" name="platforms" value="Billetera Comedor" /> Billetera Comedor</label>
        </div>
      </div>
    
      <div class="group-item">
        <label>Ambiente donde ocurrió el error:</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="environment" value="Prod" /> Prod</label>
          <label><input type="checkbox" name="environment" value="Test" /> Test</label>
          <label><input type="checkbox" name="environment" value="Dev" /> Dev</label>
          <label><input type="checkbox" name="environment" value="Demo" /> Demo</label>
        </div>
      </div>
    </div>

    <div class="group-horizontal">
      <div class="group-item">
            <label for="appVersion">Versión de la App:</label>
        <div class="checkbox-group">
          <input type="text" id="appVersion" name="appVersion">
        </div>
      </div>
    
      <div class="group-item">
        <label for="appVersion">Versión de la Web:</label>
        <div class="checkbox-group">
          <input type="text" id="appVersion" name="appVersion">
        </div>
      </div>
    </div>

    <h2>Datos de prueba</h2>


    <h2>Detalles del issue detectado</h2>
      <label for="logsAvailable">Detalle del issue detectado:</label>
      <textarea id="logsAvailable" name="logsAvailable" rows="3"></textarea>

    <label>Adjuntar imágenes – Base de datos:</label>
    <input type="file" id="dbAttachments" name="dbAttachments" accept="image/*" multiple>
    <div class="image-preview" id="dbAttachmentsPreview"></div>

    <h2>Pasos para reproducir el problema:</h2>
    <div class="steps" id="stepsContainer">
      <div class="step-item">
        <label for="step1">1.</label>
        <input type="text" id="step1" name="steps[]" placeholder="Describir paso 1">
      </div>
    </div>
    <button type="button" id="addStepBtn">Agregar paso</button>
    <button type="button" id="removeStepBtn">Eliminar paso</button>

    <h2>Información técnica adicional</h2>

    <label for="logsAvailable">Información tecnica:</label>
    <textarea id="logsAvailable" name="logsAvailable" rows="3"></textarea>

    <label>Adjuntar imágenes – Más adjuntos:</label>
    <input type="file" id="moreAttachments" name="moreAttachments" accept="image/*" multiple>
    <div class="image-preview" id="moreAttachmentsPreview"></div>

    <button type="button" id="generatePdfBtn">Generar PDF</button>
  </form>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const addStepBtn = document.getElementById('addStepBtn');
    const removeStepBtn = document.getElementById('removeStepBtn');
    const stepsContainer = document.getElementById('stepsContainer');
    let stepCount = 1;

    addStepBtn.addEventListener('click', () => {
      stepCount++;
      const stepDiv = document.createElement('div');
      stepDiv.className = 'step-item';
      stepDiv.innerHTML = `
        <label for="step${stepCount}">${stepCount}.</label>
        <input type="text" id="step${stepCount}" name="steps[]" placeholder="Describir paso ${stepCount}">
      `;
      stepsContainer.appendChild(stepDiv);
    });

    removeStepBtn.addEventListener('click', () => {
      const allSteps = stepsContainer.querySelectorAll('.step-item');
      if (allSteps.length > 1) {
        stepsContainer.removeChild(allSteps[allSteps.length - 1]);
        stepCount--;
      }
    });

    function previewImages(input, container) {
      container.innerHTML = '';
      const files = input.files;
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.onload = () => URL.revokeObjectURL(img.src);
        container.appendChild(img);
      }
    }

    const dbAttachmentsInput = document.getElementById('dbAttachments');
    const dbAttachmentsPreview = document.getElementById('dbAttachmentsPreview');
    dbAttachmentsInput.addEventListener('change', () => previewImages(dbAttachmentsInput, dbAttachmentsPreview));

    const moreAttachmentsInput = document.getElementById('moreAttachments');
    const moreAttachmentsPreview = document.getElementById('moreAttachmentsPreview');
    moreAttachmentsInput.addEventListener('change', () => previewImages(moreAttachmentsInput, moreAttachmentsPreview));

    document.getElementById('generatePdfBtn').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const form = document.getElementById('reportForm');
      const formData = new FormData(form);

      let y = 10;
      const lineHeight = 10;
      const pageHeight = doc.internal.pageSize.height;

      function addText(text) {
        if (y > pageHeight - 20) {
          doc.addPage();
          y = 10;
        }
        doc.text(text, 10, y);
        y += lineHeight;
      }

      addText('Formulario de Reporte de Incidentes – CMA');
      addText(' ');
      addText('Título referencial: ' + formData.get('issueTitle'));
      addText(' ');
      addText('Información general');
      addText('Fecha y hora de prueba: ' + formData.get('datetimeTest'));
      addText('Nombre y contacto del usuario: ' + formData.get('userContact'));
      const platforms = formData.getAll('platforms');
      addText('Plataformas afectadas: ' + (platforms.length ? platforms.join(', ') : 'Ninguna'));
      addText(' ');
      addText('Detalles del issue detectado');
      const environments = formData.getAll('environment');
      addText('Ambiente donde ocurrió el error: ' + (environments.length ? environments.join(', ') : 'Ninguno'));
      addText('Versión de la App/Web: ' + formData.get('appVersion'));
      addText(' ');
      addText('Base de datos: Ver imágenes adjuntas.');
      addText(' ');
      addText('Pasos para reproducir el problema:');
      const steps = formData.getAll('steps[]');
      steps.forEach((step, i) => {
        if (step.trim() !== '') {
          addText((i + 1) + '. ' + step);
        }
      });
      addText(' ');
      addText('Información técnica adicional');
      addText('Logs disponibles: ' + formData.get('logsAvailable'));
      addText('Intento de reproducir con otra cuenta/dispositivo: ' + formData.get('reproduceAttempt'));
      addText('Patrón detectado: ' + formData.get('patternDetected'));

      async function addImagesToPdf(inputElement, title) {
        const files = inputElement.files;
        if (!files || files.length === 0) return;

        addText(' ');
        addText(title);

        for (const file of files) {
          if (!file.type.startsWith('image/')) continue;

          const imgDataUrl = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(file);
          });

          const imgProps = doc.getImageProperties(imgDataUrl);
          const pdfWidth = doc.internal.pageSize.getWidth() - 20;
          const ratio = pdfWidth / imgProps.width;
          const pdfHeight = imgProps.height * ratio;

          if (y + pdfHeight > pageHeight - 10) {
            doc.addPage();
            y = 10;
          }

          doc.addImage(imgDataUrl, 'JPEG', 10, y, pdfWidth, pdfHeight);
          y += pdfHeight + 10;
        }
      }

      await addImagesToPdf(dbAttachmentsInput, 'Imágenes adjuntas – Base de Datos');
      await addImagesToPdf(moreAttachmentsInput, 'Imágenes adjuntas – Más Adjuntos');

      doc.save('Reporte_Incidentes_CMA.pdf');
    });
  </script>

</body>
</html>
